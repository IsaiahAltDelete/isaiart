<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D&D Interactive Character Sheet</title>
  <!-- Import Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <!-- Import Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background-image: url('background.jpg'); /* Ensure your background image is named background.jpg or background.jpeg */
      background-repeat: repeat; /* Tiles the background image */
      background-size: auto; /* Maintains original size */
      font-family: 'Roboto', sans-serif;
    }
    .container {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 20px;
    }
    .profile-pic {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #ccc;
      margin-bottom: 10px;
    }
    .btn-small {
      margin: 0 2px;
      padding: 0 8px;
      height: 30px;
      line-height: 30px;
      font-size: 14px;
      border-radius: 15px; /* Rounded corners */
    }
    .btn {
      border-radius: 20px; /* Rounded corners */
    }
    .card {
      border-radius: 15px; /* Rounded corners */
    }
    .modifier {
      margin-left: 5px;
      font-weight: bold;
    }
    .currency-input {
      width: 60px;
    }
    textarea {
      height: 100px; /* Increased height */
      border-radius: 10px; /* Rounded corners */
      resize: vertical; /* Allow vertical resizing */
    }
    .collection-item .secondary-content {
      right: 40px;
    }
    .star-btn {
      cursor: pointer;
      color: gold;
    }
    .scrollable {
      max-height: 150px;
      overflow-y: auto;
    }
    .spell-slot {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .spell-slot span {
      margin: 0 5px;
    }
    .fixed-label input:not(:focus) + label,
    .fixed-label input:not(:placeholder-shown) + label,
    .fixed-label textarea:not(:focus):not(:placeholder-shown) + label {
      top: -14px;
      font-size: 12px;
      color: #26a69a;
    }
    /* Compact the sections */
    .card-content {
      padding: 10px;
    }
    .input-field {
      margin-bottom: 10px;
    }
    .collection-item {
      padding-left: 10px;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .abilities .col,
      .saving-throws .col,
      .skills .col {
        width: 100%;
      }
    }
    /* Navigation Tabs Styling */
    .tabs .tab a {
      color: #26a69a;
      font-weight: bold;
    }
    .tabs .tab a:hover {
      background-color: #e0f2f1;
      border-radius: 10px;
    }
    .tabs .tab a.active {
      background-color: #26a69a;
      color: white !important;
      border-radius: 10px;
    }
    /* Edit Icon Styling */
    .edit-btn {
      cursor: pointer;
      color: #26a69a;
      margin-left: 10px;
    }
    /* Expandable Notes Styling */
    .notes-textarea {
      min-height: 100px;
      transition: height 0.2s;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar with Tabs -->
  <nav>
    <div class="nav-wrapper teal">
      <a href="#!" class="brand-logo center">D&D Character Sheet</a>
      <ul id="nav-mobile" class="left hide-on-med-and-down">
        <!-- Placeholder for left-aligned nav items if needed -->
      </ul>
      <ul class="right hide-on-med-and-down">
        <!-- Placeholder for right-aligned nav items if needed -->
      </ul>
    </div>
  </nav>

  <!-- Tabs Navigation -->
  <div class="container">
    <ul class="tabs tabs-fixed-width">
      <li class="tab col s3"><a href="#profile">Profile</a></li>
      <li class="tab col s3"><a href="#abilities">Abilities</a></li>
      <li class="tab col s3"><a href="#inventory">Inventory</a></li>
      <li class="tab col s3"><a href="#spells">Spells</a></li>
      <li class="tab col s3"><a href="#notes">Notes</a></li>
    </ul>
  </div>

  <!-- Tab Contents -->
  <div class="container">
    <!-- Profile Tab -->
    <div id="profile" class="col s12">
      <!-- Profile Section -->
      <div class="section card">
        <div class="card-content">
          <span class="card-title">Profile</span>
          <div class="row">
            <div class="col s12 m3 center">
              <img src="" alt="Profile Picture" id="profilePic" class="profile-pic responsive-img">
              <div class="file-field input-field">
                <div class="btn">
                  <span>Upload</span>
                  <input type="file" id="uploadPic" accept="image/*">
                </div>
                <div class="file-path-wrapper">
                  <input class="file-path validate" type="text" placeholder="Upload Profile Picture">
                </div>
              </div>
            </div>
            <div class="col s12 m9">
              <div class="fixed-label input-field">
                <input id="characterName" type="text" class="validate" required>
                <label for="characterName" class="active">Character Name</label>
              </div>
              <div class="fixed-label input-field">
                <input id="class" type="text" class="validate" required>
                <label for="class" class="active">Class</label>
              </div>
              <div class="fixed-label input-field" style="display: inline-block; width: 45%;">
                <input id="level" type="number" class="validate" min="1" value="1" required>
                <label for="level" class="active">Level</label>
              </div>
              <div class="fixed-label input-field" style="display: inline-block; width: 45%; margin-left: 10%;">
                <input id="race" type="text" class="validate" required>
                <label for="race" class="active">Race</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hit Points and Temporary HP -->
      <div class="section card">
        <div class="card-content">
          <span class="card-title">Hit Points</span>
          <div class="row">
            <div class="fixed-label input-field col s6">
              <input id="currentHP" type="number" value="0" min="0">
              <label for="currentHP" class="active">Current HP</label>
            </div>
            <div class="fixed-label input-field col s6">
              <input id="maxHP" type="number" value="0" min="0">
              <label for="maxHP" class="active">Max HP</label>
            </div>
          </div>
          <div class="row">
            <button class="btn-small red" onclick="changeHP(-5)">-5</button>
            <button class="btn-small red" onclick="changeHP(-1)">-1</button>
            <button class="btn-small green" onclick="changeHP(1)">+1</button>
            <button class="btn-small green" onclick="changeHP(5)">+5</button>
          </div>
          <div class="divider" style="margin:10px 0;"></div>
          <span class="card-title">Temporary HP</span>
          <div class="row">
            <div class="fixed-label input-field col s8">
              <input id="tempHP" type="number" value="0" min="0">
              <label for="tempHP" class="active">Temporary HP</label>
            </div>
            <div class="col s4">
              <button class="btn red" onclick="clearTempHP()">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Abilities Tab -->
    <div id="abilities" class="col s12">
      <!-- Dice Roller and Currency -->
      <div class="section card">
        <div class="card-content">
          <div class="row">
            <!-- Dice Roller -->
            <div class="col s12 m6">
              <span class="card-title">Dice Roller</span>
              <div class="row">
                <div class="input-field col s8">
                  <select id="diceType">
                    <option value="d4">d4</option>
                    <option value="d6">d6</option>
                    <option value="d8">d8</option>
                    <option value="d10">d10</option>
                    <option value="d12">d12</option>
                    <option value="d20">d20</option>
                    <option value="d100">d100</option>
                  </select>
                  <label>Choose a die</label>
                </div>
                <div class="input-field col s4">
                  <button class="btn" onclick="rollDice()">Roll</button>
                </div>
              </div>
              <div class="dice-result" id="diceResult" style="font-weight:bold;"></div>
            </div>
            <!-- Currency -->
            <div class="col s12 m6">
              <span class="card-title">Currency</span>
              <div class="row">
                <div class="fixed-label input-field col s3">
                  <input id="platinum" type="number" class="currency-input" value="0" min="0">
                  <label for="platinum" class="active">ðŸ’Ž Platinum</label>
                </div>
                <div class="fixed-label input-field col s3">
                  <input id="gold" type="number" class="currency-input" value="0" min="0">
                  <label for="gold" class="active">ðŸª™ Gold</label>
                </div>
                <div class="fixed-label input-field col s3">
                  <input id="silver" type="number" class="currency-input" value="0" min="0">
                  <label for="silver" class="active">ðŸª™ Silver</label>
                </div>
                <div class="fixed-label input-field col s3">
                  <input id="copper" type="number" class="currency-input" value="0" min="0">
                  <label for="copper" class="active">ðŸª™ Copper</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Abilities -->
      <div class="section card abilities">
        <div class="card-content">
          <span class="card-title">Abilities</span>
          <div class="row">
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="strength" value="10" min="1" max="30" onchange="updateModifier('strength')">
              <label for="strength" class="active">Strength</label>
              <span class="modifier" id="strengthMod">+0</span>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="dexterity" value="10" min="1" max="30" onchange="updateModifier('dexterity')">
              <label for="dexterity" class="active">Dexterity</label>
              <span class="modifier" id="dexterityMod">+0</span>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="constitution" value="10" min="1" max="30" onchange="updateModifier('constitution')">
              <label for="constitution" class="active">Constitution</label>
              <span class="modifier" id="constitutionMod">+0</span>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="intelligence" value="10" min="1" max="30" onchange="updateModifier('intelligence')">
              <label for="intelligence" class="active">Intelligence</label>
              <span class="modifier" id="intelligenceMod">+0</span>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="wisdom" value="10" min="1" max="30" onchange="updateModifier('wisdom')">
              <label for="wisdom" class="active">Wisdom</label>
              <span class="modifier" id="wisdomMod">+0</span>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input type="number" id="charisma" value="10" min="1" max="30" onchange="updateModifier('charisma')">
              <label for="charisma" class="active">Charisma</label>
              <span class="modifier" id="charismaMod">+0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Combat Stats and Saving Throws -->
      <div class="section card">
        <div class="card-content">
          <div class="row">
            <!-- Combat Stats -->
            <div class="col s12 m6">
              <span class="card-title">Combat Stats</span>
              <div class="row">
                <div class="fixed-label input-field col s4">
                  <input id="armorClass" type="number" value="10" min="0">
                  <label for="armorClass" class="active">Armor Class</label>
                </div>
                <div class="fixed-label input-field col s4">
                  <input id="initiative" type="number" value="0" min="0">
                  <label for="initiative" class="active">Initiative</label>
                </div>
                <div class="fixed-label input-field col s4">
                  <input id="speed" type="number" value="30" min="0">
                  <label for="speed" class="active">Speed</label>
                </div>
              </div>
            </div>
            <!-- Saving Throws -->
            <div class="col s12 m6">
              <span class="card-title">Saving Throws</span>
              <div class="row">
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveStrength" type="number" value="0" min="0">
                  <label for="saveStrength" class="active">Strength</label>
                </div>
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveDexterity" type="number" value="0" min="0">
                  <label for="saveDexterity" class="active">Dexterity</label>
                </div>
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveConstitution" type="number" value="0" min="0">
                  <label for="saveConstitution" class="active">Constitution</label>
                </div>
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveIntelligence" type="number" value="0" min="0">
                  <label for="saveIntelligence" class="active">Intelligence</label>
                </div>
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveWisdom" type="number" value="0" min="0">
                  <label for="saveWisdom" class="active">Wisdom</label>
                </div>
                <div class="fixed-label input-field col s6 m4">
                  <input id="saveCharisma" type="number" value="0" min="0">
                  <label for="saveCharisma" class="active">Charisma</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Skills -->
      <div class="section card skills">
        <div class="card-content">
          <span class="card-title">Skills</span>
          <div class="row scrollable">
            <div class="fixed-label input-field col s6 m4">
              <input id="acrobatics" type="number" value="0" min="0">
              <label for="acrobatics" class="active">Acrobatics</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="animalHandling" type="number" value="0" min="0">
              <label for="animalHandling" class="active">Animal Handling</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="arcana" type="number" value="0" min="0">
              <label for="arcana" class="active">Arcana</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="athletics" type="number" value="0" min="0">
              <label for="athletics" class="active">Athletics</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="deception" type="number" value="0" min="0">
              <label for="deception" class="active">Deception</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="history" type="number" value="0" min="0">
              <label for="history" class="active">History</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="insight" type="number" value="0" min="0">
              <label for="insight" class="active">Insight</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="intimidation" type="number" value="0" min="0">
              <label for="intimidation" class="active">Intimidation</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="investigation" type="number" value="0" min="0">
              <label for="investigation" class="active">Investigation</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="medicine" type="number" value="0" min="0">
              <label for="medicine" class="active">Medicine</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="nature" type="number" value="0" min="0">
              <label for="nature" class="active">Nature</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="perception" type="number" value="0" min="0">
              <label for="perception" class="active">Perception</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="performance" type="number" value="0" min="0">
              <label for="performance" class="active">Performance</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="persuasion" type="number" value="0" min="0">
              <label for="persuasion" class="active">Persuasion</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="religion" type="number" value="0" min="0">
              <label for="religion" class="active">Religion</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="sleightOfHand" type="number" value="0" min="0">
              <label for="sleightOfHand" class="active">Sleight of Hand</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="stealth" type="number" value="0" min="0">
              <label for="stealth" class="active">Stealth</label>
            </div>
            <div class="fixed-label input-field col s6 m4">
              <input id="survival" type="number" value="0" min="0">
              <label for="survival" class="active">Survival</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventory Tab -->
    <div id="inventory" class="col s12">
      <!-- Inventory Section -->
      <div class="section card">
        <div class="card-content">
          <span class="card-title">Inventory</span>
          <div class="row">
            <div class="input-field col s12">
              <input id="searchInventory" type="text" placeholder="Search inventory...">
            </div>
            <div class="col s12">
              <ul class="collection scrollable" id="inventoryList">
                <!-- Inventory items will be added here -->
              </ul>
            </div>
            <div class="col s12">
              <button class="btn" onclick="addItem()">Add Item</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Spells Tab -->
    <div id="spells" class="col s12">
      <!-- Spell Slots -->
      <div class="section card">
        <div class="card-content">
          <span class="card-title">Spell Slots</span>
          <div class="row">
            <div class="col s12">
              <div id="spellSlotsContainer">
                <!-- Spell slots will be generated here -->
                <div class="spell-slot" data-level="1">
                  <span>Level 1:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(0, 1)">+</button>
                  <span id="spellSlot0">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(0, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="2">
                  <span>Level 2:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(1, 1)">+</button>
                  <span id="spellSlot1">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(1, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="3">
                  <span>Level 3:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(2, 1)">+</button>
                  <span id="spellSlot2">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(2, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="4">
                  <span>Level 4:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(3, 1)">+</button>
                  <span id="spellSlot3">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(3, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="5">
                  <span>Level 5:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(4, 1)">+</button>
                  <span id="spellSlot4">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(4, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="6">
                  <span>Level 6:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(5, 1)">+</button>
                  <span id="spellSlot5">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(5, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="7">
                  <span>Level 7:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(6, 1)">+</button>
                  <span id="spellSlot6">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(6, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="8">
                  <span>Level 8:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(7, 1)">+</button>
                  <span id="spellSlot7">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(7, -1)">-</button>
                </div>
                <div class="spell-slot" data-level="9">
                  <span>Level 9:</span>
                  <button class="btn-small green" onclick="changeSpellSlot(8, 1)">+</button>
                  <span id="spellSlot8">0/0</span>
                  <button class="btn-small red" onclick="changeSpellSlot(8, -1)">-</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Spellbook and Active Spells -->
      <div class="section card">
        <div class="card-content">
          <div class="row">
            <!-- Spellbook -->
            <div class="col s12 m6">
              <span class="card-title">Spellbook</span>
              <div class="row">
                <div class="input-field col s12">
                  <input id="searchSpells" type="text" placeholder="Search spells...">
                </div>
                <div class="col s12">
                  <button class="btn" onclick="addSpell()">Add Spell</button>
                  <select id="spellLevel">
                    <option value="Cantrip">Cantrip</option>
                    <option value="Level 1">Level 1</option>
                    <option value="Level 2">Level 2</option>
                    <option value="Level 3">Level 3</option>
                    <option value="Level 4">Level 4</option>
                    <option value="Level 5">Level 5</option>
                    <option value="Level 6">Level 6</option>
                    <option value="Level 7">Level 7</option>
                    <option value="Level 8">Level 8</option>
                    <option value="Level 9">Level 9</option>
                  </select>
                  <label>Spell Level</label>
                </div>
                <div class="col s12">
                  <ul class="collection scrollable" id="spellbookList">
                    <!-- Spells will be added here -->
                  </ul>
                </div>
              </div>
            </div>
            <!-- Active Spells -->
            <div class="col s12 m6">
              <span class="card-title">Active Spells</span>
              <div class="row">
                <div class="col s12">
                  <ul class="collection scrollable" id="activeSpellsList">
                    <!-- Active spells will be added here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Tab -->
    <div id="notes" class="col s12">
      <!-- Notes Section -->
      <div class="section card">
        <div class="card-content">
          <span class="card-title">Notes</span>
          <div class="row">
            <div class="fixed-label input-field col s12">
              <textarea id="characterNotes" class="materialize-textarea notes-textarea">Character notes...</textarea>
              <label for="characterNotes" class="active">Character Notes</label>
            </div>
            <div class="fixed-label input-field col s12 m6">
              <textarea id="personality" class="materialize-textarea notes-textarea">Personality traits...</textarea>
              <label for="personality" class="active">Personality Traits</label>
            </div>
            <div class="fixed-label input-field col s12 m6">
              <textarea id="ideals" class="materialize-textarea notes-textarea">Ideals...</textarea>
              <label for="ideals" class="active">Ideals</label>
            </div>
            <div class="fixed-label input-field col s12 m6">
              <textarea id="bonds" class="materialize-textarea notes-textarea">Bonds...</textarea>
              <label for="bonds" class="active">Bonds</label>
            </div>
            <div class="fixed-label input-field col s12 m6">
              <textarea id="flaws" class="materialize-textarea notes-textarea">Flaws...</textarea>
              <label for="flaws" class="active">Flaws</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Materialize JS and dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Materialize components
      M.AutoInit();
      loadProfilePic();
      loadModifiers();
      loadInventory();
      loadSpells();
      loadActiveSpells();
      loadSpellSlots();
      loadNotes();

      // Initialize Tabs
      var elems = document.querySelectorAll('.tabs');
      var instances = M.Tabs.init(elems, {
        swipeable: true
      });
    });

    // Profile Picture Handling
    const uploadPic = document.getElementById('uploadPic');
    const profilePic = document.getElementById('profilePic');

    uploadPic.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          profilePic.src = e.target.result;
          localStorage.setItem('profilePic', e.target.result);
        }
        reader.readAsDataURL(file);
      }
    });

    function loadProfilePic() {
      const pic = localStorage.getItem('profilePic');
      if (pic) {
        profilePic.src = pic;
      } else {
        profilePic.src = 'https://via.placeholder.com/100';
      }
    }

    // HP Handling
    function changeHP(amount) {
      const currentHP = document.getElementById('currentHP');
      const maxHP = document.getElementById('maxHP');
      let newHP = parseInt(currentHP.value) + amount;
      newHP = Math.max(0, Math.min(newHP, parseInt(maxHP.value)));
      currentHP.value = newHP;
      saveData('currentHP', newHP);
    }

    // Temporary HP Handling
    function clearTempHP() {
      document.getElementById('tempHP').value = 0;
      saveData('tempHP', 0);
    }

    // Dice Roller
    function rollDice() {
      const diceType = document.getElementById('diceType').value;
      const sides = parseInt(diceType.substring(1));
      const result = Math.floor(Math.random() * sides) + 1;
      document.getElementById('diceResult').textContent = `You rolled a ${result}`;
      saveData('diceResult', `You rolled a ${result}`);
    }

    // Spell Slot Handling
    function changeSpellSlot(index, amount) {
      const spellSlot = document.getElementById(`spellSlot${index}`);
      let [used, total] = spellSlot.textContent.split('/').map(Number);
      used += amount;
      used = Math.max(0, Math.min(used, total));
      spellSlot.textContent = `${used}/${total}`;
      saveSpellSlot(index, used, total);
    }

    // Abilities Modifiers
    function updateModifier(ability) {
      const score = parseInt(document.getElementById(ability).value);
      const mod = Math.floor((score - 10) / 2);
      document.getElementById(`${ability}Mod`).textContent = (mod >= 0 ? '+' : '') + mod;
      saveData(ability, score);
      saveData(`${ability}Mod`, mod);
    }

    function loadModifiers() {
      const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
      abilities.forEach(ability => {
        const score = localStorage.getItem(ability) || 10;
        document.getElementById(ability).value = score;
        const mod = Math.floor((score - 10) / 2);
        document.getElementById(`${ability}Mod`).textContent = (mod >= 0 ? '+' : '') + mod;
      });
    }

    // Inventory Handling
    function addItem() {
      const itemName = prompt('Enter item name:');
      if (itemName) {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.textContent = itemName;
        const removeBtn = document.createElement('a');
        removeBtn.href = '#';
        removeBtn.className = 'secondary-content';
        removeBtn.innerHTML = '<i class="material-icons">delete</i>';
        removeBtn.onclick = function() {
          li.remove();
          saveInventory();
        };
        li.appendChild(removeBtn);
        document.getElementById('inventoryList').appendChild(li);
        saveInventory();
      }
    }

    function saveInventory() {
      const items = [];
      document.querySelectorAll('#inventoryList .collection-item').forEach(item => {
        items.push(item.firstChild.textContent);
      });
      localStorage.setItem('inventory', JSON.stringify(items));
    }

    function loadInventory() {
      const items = JSON.parse(localStorage.getItem('inventory')) || [];
      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.textContent = item;
        const removeBtn = document.createElement('a');
        removeBtn.href = '#';
        removeBtn.className = 'secondary-content';
        removeBtn.innerHTML = '<i class="material-icons">delete</i>';
        removeBtn.onclick = function() {
          li.remove();
          saveInventory();
        };
        li.appendChild(removeBtn);
        document.getElementById('inventoryList').appendChild(li);
      });
    }

    // Spellbook Handling with Editable Spell Levels
    function addSpell() {
      const spellName = prompt('Enter spell name:');
      const spellLevel = document.getElementById('spellLevel').value;
      if (spellName && spellLevel) {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.innerHTML = `
          <span class="spell-name">${spellName}</span> 
          (<span class="spell-level">${spellLevel}</span>)
          <a href="#" class="secondary-content" onclick="addToActiveSpells('${spellName}')">
            <i class="material-icons star-btn">star_border</i>
          </a>
          <a href="#" class="secondary-content" style="right: 40px;" onclick="removeSpell(this)">
            <i class="material-icons">delete</i>
          </a>
          <a href="#" class="secondary-content edit-btn" onclick="editSpell(this)">
            <i class="material-icons">edit</i>
          </a>
        `;
        document.getElementById('spellbookList').appendChild(li);
        saveSpells();
      }
    }

    function removeSpell(element) {
      element.parentElement.remove();
      saveSpells();
    }

    function editSpell(element) {
      const li = element.parentElement;
      const spellNameSpan = li.querySelector('.spell-name');
      const spellLevelSpan = li.querySelector('.spell-level');

      const currentName = spellNameSpan.textContent;
      const currentLevel = spellLevelSpan.textContent;

      const newName = prompt('Edit spell name:', currentName);
      if (newName === null) return; // Cancelled

      const newLevel = prompt('Edit spell level (Cantrip or Level 1-9):', currentLevel);
      if (newLevel === null) return; // Cancelled

      if (newName.trim() === '' || newLevel.trim() === '') {
        alert('Spell name and level cannot be empty.');
        return;
      }

      spellNameSpan.textContent = newName;
      spellLevelSpan.textContent = newLevel;
      saveSpells();
    }

    function addToActiveSpells(spellName) {
      const activeList = document.getElementById('activeSpellsList');
      // Check if spell already exists
      const exists = Array.from(activeList.children).some(li => li.textContent.trim() === spellName);
      if (!exists) {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.textContent = spellName;
        const removeBtn = document.createElement('a');
        removeBtn.href = '#';
        removeBtn.className = 'secondary-content';
        removeBtn.innerHTML = '<i class="material-icons">delete</i>';
        removeBtn.onclick = function() {
          li.remove();
          saveActiveSpells();
        };
        li.appendChild(removeBtn);
        activeList.appendChild(li);
        saveActiveSpells();
      }
    }

    function saveSpells() {
      const spells = [];
      document.querySelectorAll('#spellbookList .collection-item').forEach(item => {
        const spellName = item.querySelector('.spell-name').textContent;
        const spellLevel = item.querySelector('.spell-level').textContent;
        spells.push({ name: spellName, level: spellLevel });
      });
      localStorage.setItem('spells', JSON.stringify(spells));
    }

    function loadSpells() {
      const spells = JSON.parse(localStorage.getItem('spells')) || [];
      spells.forEach(spell => {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.innerHTML = `
          <span class="spell-name">${spell.name}</span> 
          (<span class="spell-level">${spell.level}</span>)
          <a href="#" class="secondary-content" onclick="addToActiveSpells('${spell.name}')">
            <i class="material-icons star-btn">star_border</i>
          </a>
          <a href="#" class="secondary-content" style="right: 40px;" onclick="removeSpell(this)">
            <i class="material-icons">delete</i>
          </a>
          <a href="#" class="secondary-content edit-btn" onclick="editSpell(this)">
            <i class="material-icons">edit</i>
          </a>
        `;
        document.getElementById('spellbookList').appendChild(li);
      });
    }

    // Active Spells Handling
    function saveActiveSpells() {
      const spells = [];
      document.querySelectorAll('#activeSpellsList .collection-item').forEach(item => {
        spells.push(item.firstChild.textContent);
      });
      localStorage.setItem('activeSpells', JSON.stringify(spells));
    }

    function loadActiveSpells() {
      const spells = JSON.parse(localStorage.getItem('activeSpells')) || [];
      spells.forEach(spell => {
        const li = document.createElement('li');
        li.className = 'collection-item';
        li.textContent = spell;
        const removeBtn = document.createElement('a');
        removeBtn.href = '#';
        removeBtn.className = 'secondary-content';
        removeBtn.innerHTML = '<i class="material-icons">delete</i>';
        removeBtn.onclick = function() {
          li.remove();
          saveActiveSpells();
        };
        li.appendChild(removeBtn);
        document.getElementById('activeSpellsList').appendChild(li);
      });
    }

    // Spell Slots Handling
    function saveSpellSlot(index, used, total) {
      let spellSlots = JSON.parse(localStorage.getItem('spellSlots')) || {};
      spellSlots[index] = { used, total };
      localStorage.setItem('spellSlots', JSON.stringify(spellSlots));
    }

    function loadSpellSlots() {
      const spellSlots = JSON.parse(localStorage.getItem('spellSlots')) || {};
      for (let i = 0; i < 9; i++) {
        if (spellSlots[i]) {
          document.getElementById(`spellSlot${i}`).textContent = `${spellSlots[i].used}/${spellSlots[i].total}`;
        }
      }
    }

    // Notes Handling
    function saveNotes() {
      const notes = {
        characterNotes: document.getElementById('characterNotes').value,
        personality: document.getElementById('personality').value,
        ideals: document.getElementById('ideals').value,
        bonds: document.getElementById('bonds').value,
        flaws: document.getElementById('flaws').value
      };
      localStorage.setItem('notes', JSON.stringify(notes));
    }

    function loadNotes() {
      const notes = JSON.parse(localStorage.getItem('notes')) || {};
      document.getElementById('characterNotes').value = notes.characterNotes || 'Character notes...';
      document.getElementById('personality').value = notes.personality || 'Personality traits...';
      document.getElementById('ideals').value = notes.ideals || 'Ideals...';
      document.getElementById('bonds').value = notes.bonds || 'Bonds...';
      document.getElementById('flaws').value = notes.flaws || 'Flaws...';
      M.updateTextFields();
    }

    // General Data Saving
    function saveData(key, value) {
      localStorage.setItem(key, value);
    }

    // Auto-save functionality for inputs and textareas
    document.querySelectorAll('input, textarea, select').forEach(element => {
      element.addEventListener('change', () => {
        if (element.type === 'checkbox' || element.type === 'radio') {
          saveData(element.id, element.checked);
        } else {
          saveData(element.id, element.value);
        }
      });
    });

    // Search Functionality for Inventory and Spells
    document.getElementById('searchInventory').addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      document.querySelectorAll('#inventoryList .collection-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    document.getElementById('searchSpells').addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      document.querySelectorAll('#spellbookList .collection-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Expandable Notes Functionality
    const textareas = document.querySelectorAll('.notes-textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', autoResize);
    });

    function autoResize() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      saveNotes(); // Save notes whenever resized
    }
  </script>
</body>
</html>
