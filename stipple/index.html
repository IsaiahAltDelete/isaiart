<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stipple Art Studio</title>

  <!-- Favicon (Modern SVG Icon) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='none' stroke='%23a78bfa' stroke-width='10'/%3E%3Ccircle cx='50' cy='25' r='5' fill='%23a78bfa'/%3E%3Ccircle cx='50' cy='75' r='5' fill='%23a78bfa'/%3E%3Ccircle cx='25' cy='50' r='5' fill='%23a78bfa'/%3E%3Ccircle cx='75' cy='50' r='5' fill='%23a78bfa'/%3E%3C/svg%3E">

  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Google Material Symbols (Outlined) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TailwindCSS Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'base': '#111015',
            'panel': 'rgba(38, 37, 43, 0.5)',
            'surface': '#26252b',
            'primary': '#a78bfa', // Violet-500
            'primary-hover': '#c4b5fd', // Violet-300
            'text-main': '#e5e7eb', // Gray-200
            'text-muted': '#9ca3af', // Gray-400
            'border-color': 'rgba(255, 255, 255, 0.1)',
          }
        }
      }
    }
  </script>

  <!-- Custom CSS for elements Tailwind can't easily style -->
  <style>
    /* Base styles */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #111015;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
      background-size: 25px 25px;
      color: #e5e7eb;
    }

    /* Glassmorphism Panel Style */
    .glass-panel {
      background: rgba(38, 37, 43, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4a4a52;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #6b6b74;
    }

    /* Custom Range Slider */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      outline: none;
      transition: all 0.2s ease;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #a78bfa;
      border: 3px solid #111015;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px #a78bfa;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #a78bfa;
      border: 3px solid #111015;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Custom Checkbox */
    .custom-checkbox input:checked ~ .checkmark {
      background-color: #a78bfa;
      border-color: #a78bfa;
    }
    .custom-checkbox .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 7px;
      top: 3px;
      width: 6px;
      height: 12px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    /* Custom Color Picker */
    input[type="color"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 40px;
      height: 40px;
      background-color: transparent;
      border: none;
      cursor: pointer;
    }
    input[type="color"]::-webkit-color-swatch {
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    input[type="color"]::-moz-color-swatch {
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="p-4 lg:p-6 antialiased">

  <main id="editor-container" class="grid grid-cols-1 lg:grid-cols-[340px_1fr_340px] gap-6 max-w-screen-2xl mx-auto h-[calc(100vh-3rem)]">

    <!-- Left Controls Panel: Filter Settings -->
    <div id="left-controls" class="glass-panel rounded-2xl p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
      <h2 class="text-xl font-bold text-center text-text-main border-b border-border-color pb-3">Stipple Controls</h2>
      
      <!-- File Upload -->
      <div id="upload-container" class="border-2 border-dashed border-border-color rounded-lg p-6 text-center cursor-pointer transition-all duration-300 hover:border-primary hover:bg-surface">
        <span class="material-symbols-outlined text-4xl text-primary">upload_file</span>
        <p class="text-text-main font-semibold mt-2">Drop image here</p>
        <p class="text-text-muted text-sm">or click to browse</p>
        <input type="file" id="imageLoader" accept="image/*" class="hidden">
      </div>

      <!-- Controls -->
      <div class="flex flex-col gap-5">
        <div class="control-group">
          <div class="flex justify-between items-center mb-2">
            <label for="density" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">grid_on</span>Density</label>
            <span id="density-value" class="text-xs font-mono bg-surface px-2 py-1 rounded">10</span>
          </div>
          <input type="range" id="density" min="2" max="20" value="10">
        </div>

        <div class="control-group">
          <div class="flex justify-between items-center mb-2">
            <label for="dotSize" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">blur_on</span>Dot Size</label>
            <span id="dotSize-value" class="text-xs font-mono bg-surface px-2 py-1 rounded">5</span>
          </div>
          <input type="range" id="dotSize" min="1" max="20" value="5">
        </div>

        <div class="control-group">
          <div class="flex justify-between items-center mb-2">
            <label for="amount" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">tune</span>Intensity</label>
            <span id="amount-value" class="text-xs font-mono bg-surface px-2 py-1 rounded">1.0</span>
          </div>
          <input type="range" id="amount" min="0" max="2" step="0.1" value="1">
        </div>

        <div class="control-group flex items-center justify-between p-3 bg-surface rounded-lg">
          <label for="originalColors" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">palette</span>Use Original Colors</label>
          <label class="custom-checkbox relative inline-block w-5 h-5">
            <input type="checkbox" id="originalColors" class="opacity-0 w-0 h-0">
            <span class="checkmark absolute top-0 left-0 h-5 w-5 bg-transparent border-2 border-border-color rounded transition-all"></span>
          </label>
        </div>

        <div id="stippleColorContainer" class="control-group flex items-center justify-between p-3 bg-surface rounded-lg">
          <label for="colorPicker" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">colorize</span>Stipple Color</label>
          <input type="color" id="colorPicker" value="#ffffff">
        </div>

        <div class="control-group flex items-center justify-between p-3 bg-surface rounded-lg">
          <label for="invertEffect" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">invert_colors</span>Invert Effect</label>
          <label class="custom-checkbox relative inline-block w-5 h-5">
            <input type="checkbox" id="invertEffect" class="opacity-0 w-0 h-0">
            <span class="checkmark absolute top-0 left-0 h-5 w-5 bg-transparent border-2 border-border-color rounded transition-all"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Canvas Card (Center) -->
    <div id="canvas-card" class="glass-panel rounded-2xl p-6 flex flex-col">
      <div class="flex justify-between items-center border-b border-border-color pb-3 mb-4">
        <h2 class="text-xl font-bold text-text-main">Artwork Preview</h2>
        <div class="flex items-center gap-2">
          <label for="canvasColor" class="text-sm text-text-muted">BG</label>
          <input type="color" id="canvasColor" value="#111015">
        </div>
      </div>
      <div id="canvas-container" class="flex-grow flex items-center justify-center bg-base rounded-lg transition-colors duration-300 p-4">
        <canvas id="stippleCanvas" class="max-w-full max-h-full object-contain rounded-md"></canvas>
      </div>
    </div>

    <!-- Right Controls Panel: Export Settings -->
    <div id="right-controls" class="glass-panel rounded-2xl p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
      <h2 class="text-xl font-bold text-center text-text-main border-b border-border-color pb-3">Export Options</h2>
      
      <div class="flex flex-col gap-5">
        <div class="control-group">
          <label for="exportFormat" class="flex items-center gap-2 text-sm font-medium text-text-main mb-2"><span class="material-symbols-outlined text-lg">save</span>Export Format</label>
          <select id="exportFormat" class="w-full p-3 bg-surface border border-border-color rounded-lg text-text-main focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none" style="background-image: url('data:image/svg+xml;utf8,<svg fill=\'%239ca3af\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/><path d=\'M0 0h24v24H0z\' fill=\'none\'/></svg>'); background-repeat: no-repeat; background-position-x: 95%; background-position-y: center;">
            <option value="png">PNG</option>
            <option value="jpeg">JPEG</option>
            <option value="svg">SVG (Vector)</option>
          </select>
        </div>

        <div id="transparentBgContainer" class="control-group flex items-center justify-between p-3 bg-surface rounded-lg">
          <label for="transparentBg" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">layers_clear</span>Transparent BG (PNG)</label>
          <label class="custom-checkbox relative inline-block w-5 h-5">
            <input type="checkbox" id="transparentBg" class="opacity-0 w-0 h-0">
            <span class="checkmark absolute top-0 left-0 h-5 w-5 bg-transparent border-2 border-border-color rounded transition-all"></span>
          </label>
        </div>

        <div id="bgColorContainer" class="control-group flex items-center justify-between p-3 bg-surface rounded-lg">
          <label for="bgColor" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">format_color_fill</span>Background Color</label>
          <input type="color" id="bgColor" value="#111015">
        </div>

        <div id="qualityContainer" class="control-group hidden">
          <div class="flex justify-between items-center mb-2">
            <label for="qualitySlider" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">high_quality</span>JPEG Quality</label>
            <span id="quality-value" class="text-xs font-mono bg-surface px-2 py-1 rounded">0.90</span>
          </div>
          <input type="range" id="qualitySlider" min="0.1" max="1" step="0.05" value="0.9">
        </div>

        <div id="scaleContainer" class="control-group">
          <div class="flex justify-between items-center mb-2">
            <label for="scaleSlider" class="flex items-center gap-2 text-sm font-medium text-text-main"><span class="material-symbols-outlined text-lg">zoom_out_map</span>Output Scale</label>
            <span id="scale-value" class="text-xs font-mono bg-surface px-2 py-1 rounded">1.0x</span>
          </div>
          <input type="range" id="scaleSlider" min="1" max="4" step="0.1" value="1">
        </div>
      </div>

      <div class="mt-auto">
        <button id="downloadBtn" class="w-full bg-primary text-base font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 hover:bg-primary-hover hover:shadow-lg hover:shadow-primary/30 disabled:bg-surface disabled:text-text-muted disabled:cursor-not-allowed">
          <span class="material-symbols-outlined">download</span>
          Generate & Download
        </button>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM Elements ---
      const imageLoader = document.getElementById('imageLoader');
      const uploadContainer = document.getElementById('upload-container');
      const canvas = document.getElementById('stippleCanvas');
      const ctx = canvas.getContext('2d');
      
      const densitySlider = document.getElementById('density');
      const dotSizeSlider = document.getElementById('dotSize');
      const amountSlider = document.getElementById('amount');
      const originalColorsCheckbox = document.getElementById('originalColors');
      const colorPicker = document.getElementById('colorPicker');
      const stippleColorContainer = document.getElementById('stippleColorContainer');
      const invertEffectCheckbox = document.getElementById('invertEffect');

      const densityValue = document.getElementById('density-value');
      const dotSizeValue = document.getElementById('dotSize-value');
      const amountValue = document.getElementById('amount-value');

      const exportFormatSelect = document.getElementById('exportFormat');
      const transparentCheckbox = document.getElementById('transparentBg');
      const bgColorPicker = document.getElementById('bgColor');
      const transparentBgContainer = document.getElementById('transparentBgContainer');
      const bgColorContainer = document.getElementById('bgColorContainer');
      const qualityContainer = document.getElementById('qualityContainer');
      const qualitySlider = document.getElementById('qualitySlider');
      const qualityValue = document.getElementById('quality-value');
      const scaleContainer = document.getElementById('scaleContainer');
      const scaleSlider = document.getElementById('scaleSlider');
      const scaleValue = document.getElementById('scale-value');
      const downloadBtn = document.getElementById('downloadBtn');

      const canvasColorPicker = document.getElementById('canvasColor');
      const canvasContainer = document.getElementById('canvas-container');

      // --- State ---
      let img = new Image();
      const offCanvas = document.createElement('canvas');
      const offCtx = offCanvas.getContext('2d');

      // --- Initial Setup ---
      const setupInitialCanvas = () => {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        ctx.font = "16px Poppins";
        ctx.fillStyle = "#9ca3af";
        ctx.textAlign = "center";
        ctx.fillText("Upload an image to begin", canvas.width / (2*dpr), canvas.height / (2*dpr));
        downloadBtn.disabled = true;
      };
      setupInitialCanvas();

      // --- Event Listeners ---

      // File Upload
      uploadContainer.addEventListener('click', () => imageLoader.click());
      uploadContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadContainer.classList.add('border-primary', 'bg-surface');
      });
      uploadContainer.addEventListener('dragleave', () => {
        uploadContainer.classList.remove('border-primary', 'bg-surface');
      });
      uploadContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadContainer.classList.remove('border-primary', 'bg-surface');
        if (e.dataTransfer.files.length) {
          imageLoader.files = e.dataTransfer.files;
          imageLoader.dispatchEvent(new Event('change'));
        }
      });
      imageLoader.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          img = new Image();
          img.onload = () => {
            downloadBtn.disabled = false;
            applyStipple();
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Control Listeners
      const controls = [densitySlider, dotSizeSlider, amountSlider, colorPicker, bgColorPicker, canvasColorPicker];
      controls.forEach(control => control.addEventListener('input', applyStipple));
      
      const checkboxes = [originalColorsCheckbox, invertEffectCheckbox, transparentCheckbox];
      checkboxes.forEach(checkbox => checkbox.addEventListener('change', applyStipple));

      // Update UI based on control changes
      densitySlider.addEventListener('input', () => densityValue.textContent = densitySlider.value);
      dotSizeSlider.addEventListener('input', () => dotSizeValue.textContent = dotSizeSlider.value);
      amountSlider.addEventListener('input', () => amountValue.textContent = parseFloat(amountSlider.value).toFixed(1));
      qualitySlider.addEventListener('input', () => qualityValue.textContent = parseFloat(qualitySlider.value).toFixed(2));
      scaleSlider.addEventListener('input', () => scaleValue.textContent = `${parseFloat(scaleSlider.value).toFixed(1)}x`);

      originalColorsCheckbox.addEventListener('change', () => {
        stippleColorContainer.style.display = originalColorsCheckbox.checked ? 'none' : 'flex';
      });

      exportFormatSelect.addEventListener('change', () => {
        const format = exportFormatSelect.value;
        transparentBgContainer.style.display = format === 'png' ? 'flex' : 'none';
        bgColorContainer.style.display = (format === 'png' && transparentCheckbox.checked) ? 'none' : 'flex';
        qualityContainer.style.display = format === 'jpeg' ? 'block' : 'none';
        scaleContainer.style.display = format === 'svg' ? 'none' : 'block';
      });

      transparentCheckbox.addEventListener('change', () => {
        bgColorContainer.style.display = transparentCheckbox.checked ? 'none' : 'flex';
      });

      canvasColorPicker.addEventListener('input', () => {
        canvasContainer.style.backgroundColor = canvasColorPicker.value;
      });

      // Download Handler
      downloadBtn.addEventListener('click', handleDownload);

      // --- Core Functions ---

      function applyStipple() {
        if (!img.src) return;
        drawStipple(canvas, true, 1);
      }

      function drawStipple(targetCanvas, isPreview, scale = 1) {
        const ctx = targetCanvas.getContext('2d');
        const w = img.width * scale;
        const h = img.height * scale;
        targetCanvas.width = w;
        targetCanvas.height = h;

        // Set background
        const useTransparent = exportFormatSelect.value === 'png' && transparentCheckbox.checked;
        if (!isPreview && !useTransparent) {
          ctx.fillStyle = bgColorPicker.value;
          ctx.fillRect(0, 0, w, h);
        } else {
          ctx.clearRect(0, 0, w, h);
        }

        // Get pixel data
        offCanvas.width = img.width;
        offCanvas.height = img.height;
        offCtx.drawImage(img, 0, 0);
        const imageData = offCtx.getImageData(0, 0, img.width, img.height).data;

        // Get settings
        const density = parseInt(densitySlider.value, 10);
        const dotSize = parseFloat(dotSizeSlider.value);
        const amount = parseFloat(amountSlider.value);
        const useOriginalColors = originalColorsCheckbox.checked;
        const customColor = colorPicker.value;
        const invert = invertEffectCheckbox.checked;

        for (let y = 0; y < img.height; y += density) {
          for (let x = 0; x < img.width; x += density) {
            const i = (y * img.width + x) * 4;
            const r = imageData[i], g = imageData[i + 1], b = imageData[i + 2];
            const brightness = (r + g + b) / 3 / 255; // Normalized 0-1
            const radius = dotSize * amount * (invert ? brightness : 1 - brightness);

            if (radius > 0.5) {
              ctx.beginPath();
              ctx.fillStyle = useOriginalColors ? `rgb(${r},${g},${b})` : customColor;
              ctx.arc(x * scale, y * scale, radius * scale, 0, Math.PI * 2);
              ctx.fill();
            }
          }
        }
      }

      function generateSVG() {
        const density = parseInt(densitySlider.value, 10);
        const dotSize = parseFloat(dotSizeSlider.value);
        const amount = parseFloat(amountSlider.value);
        const useOriginalColors = originalColorsCheckbox.checked;
        const customColor = colorPicker.value;
        const invert = invertEffectCheckbox.checked;

        let svgCircles = '';
        offCanvas.width = img.width;
        offCanvas.height = img.height;
        offCtx.drawImage(img, 0, 0);
        const imageData = offCtx.getImageData(0, 0, img.width, img.height).data;

        for (let y = 0; y < img.height; y += density) {
          for (let x = 0; x < img.width; x += density) {
            const i = (y * img.width + x) * 4;
            const r = imageData[i], g = imageData[i + 1], b = imageData[i + 2];
            const brightness = (r + g + b) / 3 / 255;
            const radius = dotSize * amount * (invert ? brightness : 1 - brightness);
            if (radius > 0.5) {
              const fill = useOriginalColors ? `rgb(${r},${g},${b})` : customColor;
              svgCircles += `<circle cx="${x}" cy="${y}" r="${radius.toFixed(3)}" fill="${fill}" />\n`;
            }
          }
        }

        const bgRect = (exportFormatSelect.value === 'png' && transparentCheckbox.checked) ? '' : `<rect width="100%" height="100%" fill="${bgColorPicker.value}" />\n`;
        return `<svg xmlns="http://www.w3.org/2000/svg" width="${img.width}" height="${img.height}" viewBox="0 0 ${img.width} ${img.height}">\n${bgRect}${svgCircles}</svg>`;
      }

      function handleDownload() {
        if (!img.src) return;
        const format = exportFormatSelect.value;
        const fileName = `stipple-art-${Date.now()}.${format}`;
        let dataURL;

        if (format === 'svg') {
          const svgString = generateSVG();
          const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
          dataURL = URL.createObjectURL(blob);
        } else {
          const scale = parseFloat(scaleSlider.value);
          const exportCanvas = document.createElement('canvas');
          drawStipple(exportCanvas, false, scale);
          const quality = format === 'jpeg' ? parseFloat(qualitySlider.value) : undefined;
          dataURL = exportCanvas.toDataURL(`image/${format}`, quality);
        }

        const link = document.createElement('a');
        link.href = dataURL;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        if (format === 'svg') {
          URL.revokeObjectURL(dataURL);
        }
      }
    });
  </script>
</body>
</html>