<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENGINE vs ENGINE — Infinite Chess</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0c;
            --surface: #111114;
            --surface-2: #19191e;
            --surface-3: #222228;
            --border: #2a2a32;
            --border-glow: #3a3a45;
            --text: #e8e6e3;
            --text-dim: #8a8894;
            --text-muted: #55535e;
            --white-accent: #f0c94d;
            --white-accent-dim: rgba(240, 201, 77, 0.15);
            --black-accent: #7c6cf0;
            --black-accent-dim: rgba(124, 108, 240, 0.15);
            --danger: #e05555;
            --success: #4ecb71;
            --sq-light: #c8b898;
            --sq-dark: #8b7355;
            --sq-highlight: rgba(240, 201, 77, 0.45);
            --sq-highlight-dark: rgba(240, 201, 77, 0.35);
            --radius: 10px;
            --radius-sm: 6px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 800px 600px at 20% 30%, rgba(240, 201, 77, 0.04), transparent),
                radial-gradient(ellipse 600px 800px at 80% 70%, rgba(124, 108, 240, 0.04), transparent);
            pointer-events: none;
            z-index: 0;
        }
        .header { text-align: center; padding: 28px 20px 20px; position: relative; z-index: 1; }
        .header h1 { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; letter-spacing: 6px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; }
        .header .subtitle { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); }
        .scoreboard { display: flex; justify-content: center; align-items: center; gap: 32px; padding: 0 20px 20px; position: relative; z-index: 1; }
        .score-side { display: flex; align-items: center; gap: 12px; }
        .score-side .engine-name { font-family: 'Space Mono', monospace; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
        .score-side.white-side .engine-name { color: var(--white-accent); }
        .score-side.black-side .engine-name { color: var(--black-accent); }
        .score-num { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 600; min-width: 36px; text-align: center; }
        .score-side.white-side .score-num { color: var(--white-accent); }
        .score-side.black-side .score-num { color: var(--black-accent); }
        .score-divider { font-family: 'JetBrains Mono', monospace; font-size: 20px; color: var(--text-muted); }
        .main { display: grid; grid-template-columns: 280px 1fr 320px; gap: 24px; max-width: 1200px; margin: 0 auto; padding: 0 24px 24px; position: relative; z-index: 1; }
        .panel { display: flex; flex-direction: column; gap: 12px; }
        .engine-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .engine-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: transparent; transition: background 0.3s ease; }
        .engine-card.active-white::before { background: var(--white-accent); }
        .engine-card.active-black::before { background: var(--black-accent); }
        .engine-card.active-white { border-color: rgba(240, 201, 77, 0.25); background: linear-gradient(180deg, rgba(240, 201, 77, 0.05), var(--surface)); }
        .engine-card.active-black { border-color: rgba(124, 108, 240, 0.25); background: linear-gradient(180deg, rgba(124, 108, 240, 0.05), var(--surface)); }
        .engine-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .engine-identity { display: flex; align-items: center; gap: 10px; }
        .engine-piece { font-size: 22px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: var(--surface-2); }
        .engine-card.active-white .engine-piece { background: var(--white-accent-dim); }
        .engine-card.active-black .engine-piece { background: var(--black-accent-dim); }
        .engine-label { font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }
        .engine-card.white-engine .engine-label { color: var(--white-accent); }
        .engine-card.black-engine .engine-label { color: var(--black-accent); }
        .engine-timer { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 500; color: var(--text-dim); letter-spacing: 2px; transition: color 0.3s; }
        .engine-card.active-white .engine-timer { color: var(--white-accent); }
        .engine-card.active-black .engine-timer { color: var(--black-accent); }
        .engine-timer.low-time { color: var(--danger) !important; animation: pulse-time 1s infinite; }
        @keyframes pulse-time { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .engine-thinking { font-size: 12px; color: var(--text-muted); min-height: 18px; margin-top: 8px; font-family: 'JetBrains Mono', monospace; }
        .thinking-dots::after { content: ''; animation: dots 1.4s steps(4, end) infinite; }
        @keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }
        .captured-row { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 8px; min-height: 24px; }
        .captured-row .cap-piece { font-size: 16px; opacity: 0.6; filter: grayscale(0.3); }
        .settings-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
        .settings-card h3 { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 14px; }
        .setting-group { margin-bottom: 14px; }
        .setting-group:last-child { margin-bottom: 0; }
        .setting-label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .setting-value { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: var(--surface-3); border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--text); cursor: pointer; border: 2px solid var(--surface); box-shadow: 0 0 0 1px var(--border); }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); background: var(--white-accent); }
        .board-wrap { display: flex; flex-direction: column; align-items: center; gap: 16px; }
        .chessboard { width: 100%; max-width: 520px; aspect-ratio: 1; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); border-radius: var(--radius); overflow: hidden; box-shadow: 0 0 0 2px var(--border), 0 20px 60px rgba(0,0,0,0.5), 0 0 120px rgba(240,201,77,0.03); }
        .sq { display: flex; justify-content: center; align-items: center; position: relative; }
        .sq.light { background: var(--sq-light); }
        .sq.dark { background: var(--sq-dark); }
        .sq.hl.light { background: linear-gradient(135deg, var(--sq-light), var(--sq-highlight)); }
        .sq.hl.dark { background: linear-gradient(135deg, var(--sq-dark), var(--sq-highlight-dark)); }
        .sq .coord { position: absolute; font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 600; pointer-events: none; opacity: 0.45; }
        .sq.light .coord { color: var(--sq-dark); }
        .sq.dark .coord { color: var(--sq-light); }
        .coord-file { bottom: 2px; right: 3px; }
        .coord-rank { top: 2px; left: 3px; }
        .pc { font-size: clamp(28px, 5.5vw, 48px); z-index: 2; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4)); line-height: 1; user-select: none; }
        .pc.moved { animation: land 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes land { 0% { transform: scale(0.7) translateY(-8px); opacity: 0.5; } 60% { transform: scale(1.12); } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        .pc-w { color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,0.5); }
        .pc-b { color: #1a1a1a; text-shadow: 0 1px 2px rgba(255,255,255,0.15); }
        .status-bar { width: 100%; max-width: 520px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 16px; display: flex; align-items: center; gap: 10px; min-height: 44px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }
        .status-dot.live { background: var(--success); animation: glow-dot 2s infinite; }
        .status-dot.ended { background: var(--danger); }
        @keyframes glow-dot { 0%, 100% { box-shadow: 0 0 4px rgba(78,203,113,0.4); } 50% { box-shadow: 0 0 10px rgba(78,203,113,0.7); } }
        .status-text { font-size: 13px; color: var(--text-dim); flex: 1; }
        .status-text strong { color: var(--text); font-weight: 600; }
        .move-counter { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); }
        .controls-row { display: flex; gap: 8px; width: 100%; max-width: 520px; }
        .btn { flex: 1; padding: 10px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--text-dim); font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:hover { background: var(--surface-2); color: var(--text); border-color: var(--border-glow); }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
        .btn.primary { background: var(--white-accent); color: #0a0a0c; border-color: var(--white-accent); }
        .btn.primary:hover { background: #f5d565; }
        .btn.active-toggle { border-color: var(--success); color: var(--success); }
        .btn.active-toggle:hover { background: rgba(78,203,113,0.1); }
        .btn svg { width: 14px; height: 14px; }
        .analysis-panel { display: flex; flex-direction: column; gap: 12px; }
        .analysis-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; transition: border-color 0.3s; }
        .analysis-box.active-w { border-color: rgba(240,201,77,0.3); }
        .analysis-box.active-b { border-color: rgba(124,108,240,0.3); }
        .analysis-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .analysis-header .ah-title { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }
        .analysis-box.active-w .ah-title { color: var(--white-accent); }
        .analysis-box.active-b .ah-title { color: var(--black-accent); }
        .eval-badge { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; padding: 2px 8px; border-radius: 4px; background: var(--surface-3); color: var(--text-dim); }
        .analysis-body { padding: 14px 16px; font-size: 13px; line-height: 1.65; color: var(--text-dim); max-height: 160px; overflow-y: auto; }
        .analysis-body::-webkit-scrollbar { width: 4px; }
        .analysis-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .analysis-line { margin-bottom: 8px; padding-left: 12px; border-left: 2px solid var(--border); }
        .analysis-line:last-child { margin-bottom: 0; }
        .analysis-line .al-label { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); display: block; margin-bottom: 2px; }
        .analysis-box.active-w .analysis-line { border-left-color: rgba(240,201,77,0.25); }
        .analysis-box.active-b .analysis-line { border-left-color: rgba(124,108,240,0.25); }
        .move-log { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; flex: 1; }
        .move-log-header { padding: 10px 16px; border-bottom: 1px solid var(--border); font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }
        .move-log-body { padding: 10px 16px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8; color: var(--text-dim); max-height: 200px; overflow-y: auto; }
        .move-log-body::-webkit-scrollbar { width: 4px; }
        .move-log-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .move-num { color: var(--text-muted); }
        .move-w { color: var(--white-accent); }
        .move-b { color: var(--black-accent); }
        .eval-bar-wrap { width: 100%; max-width: 520px; height: 6px; background: var(--black-accent-dim); border-radius: 3px; overflow: hidden; }
        .eval-bar-fill { height: 100%; background: var(--white-accent); border-radius: 3px; width: 50%; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
        @media (max-width: 1100px) {
            .main { grid-template-columns: 1fr; max-width: 560px; }
            .panel { order: 2; flex-direction: row; gap: 12px; }
            .panel > * { flex: 1; }
            .board-wrap { order: 1; }
            .analysis-panel { order: 3; }
        }
        @media (max-width: 600px) {
            .main { padding: 0 12px 12px; gap: 12px; }
            .panel { flex-direction: column; }
            .scoreboard { gap: 16px; }
            .score-num { font-size: 22px; }
            .controls-row { flex-wrap: wrap; }
            .btn { font-size: 9px; padding: 8px 4px; min-width: 0; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Engine vs Engine</h1>
    <div class="subtitle">Infinite Chess Battle</div>
</div>
<div class="scoreboard">
    <div class="score-side white-side">
        <span class="engine-name">Nexus</span>
        <span class="score-num" id="score-w">0</span>
    </div>
    <span class="score-divider">:</span>
    <div class="score-side black-side">
        <span class="score-num" id="score-b">0</span>
        <span class="engine-name">Hydra</span>
    </div>
</div>
<div class="main">
    <div class="panel">
        <div class="engine-card white-engine" id="card-w">
            <div class="engine-header">
                <div class="engine-identity">
                    <div class="engine-piece">♔</div>
                    <span class="engine-label">Nexus</span>
                </div>
                <div class="engine-timer" id="timer-w">05:00</div>
            </div>
            <div class="captured-row" id="cap-w"></div>
            <div class="engine-thinking" id="think-w"></div>
        </div>
        <div class="engine-card black-engine" id="card-b">
            <div class="engine-header">
                <div class="engine-identity">
                    <div class="engine-piece">♚</div>
                    <span class="engine-label">Hydra</span>
                </div>
                <div class="engine-timer" id="timer-b">05:00</div>
            </div>
            <div class="captured-row" id="cap-b"></div>
            <div class="engine-thinking" id="think-b"></div>
        </div>
        <div class="settings-card">
            <h3>Parameters</h3>
            <div class="setting-group">
                <div class="setting-label"><span>Entropy</span><span class="setting-value" id="entropy-val">0.20</span></div>
                <input type="range" id="entropy-slider" min="0" max="100" value="20">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Knowledge Depth</span><span class="setting-value" id="depth-val">3</span></div>
                <input type="range" id="depth-slider" min="1" max="5" value="3">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Speed</span><span class="setting-value" id="speed-val">Normal</span></div>
                <input type="range" id="speed-slider" min="0" max="2" value="1">
            </div>
        </div>
    </div>
    <div class="board-wrap">
        <div class="eval-bar-wrap"><div class="eval-bar-fill" id="eval-bar"></div></div>
        <div class="chessboard" id="board"></div>
        <div class="status-bar">
            <div class="status-dot" id="status-dot"></div>
            <div class="status-text" id="status-text">Press <strong>Start</strong> to begin the battle.</div>
            <div class="move-counter" id="move-counter"></div>
        </div>
        <div class="controls-row">
            <button class="btn primary" id="btn-start"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>Start</button>
            <button class="btn" id="btn-pause" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>Pause</button>
            <button class="btn" id="btn-infinite"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18.2 8c5 0 5 8 0 8H12m-6.2 0c-5 0-5-8 0-8H12"/></svg>Loop</button>
        </div>
    </div>
    <div class="analysis-panel">
        <div class="analysis-box" id="analysis-w">
            <div class="analysis-header"><span class="ah-title">Nexus Analysis</span><span class="eval-badge" id="eval-w">0.0</span></div>
            <div class="analysis-body" id="analysis-body-w"><div style="color:var(--text-muted);font-style:italic">Waiting for game…</div></div>
        </div>
        <div class="analysis-box" id="analysis-b">
            <div class="analysis-header"><span class="ah-title">Hydra Analysis</span><span class="eval-badge" id="eval-b">0.0</span></div>
            <div class="analysis-body" id="analysis-body-b"><div style="color:var(--text-muted);font-style:italic">Waiting for game…</div></div>
        </div>
        <div class="move-log">
            <div class="move-log-header">Move Log</div>
            <div class="move-log-body" id="move-log"></div>
        </div>
    </div>
</div>

<!-- ========== WEB WORKER — runs AI off main thread ========== -->
<script id="worker-src" type="text/js-worker">
importScripts('https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js');

const PST = {
    p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],
    n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],
    b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,10,10,10,10,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],
    r:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],
    q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],
    k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]],
    k_end:[[-50,-40,-30,-20,-20,-30,-40,-50],[-30,-20,-10,0,0,-10,-20,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-30,0,0,0,0,-30,-30],[-50,-30,-30,-30,-30,-30,-30,-50]]
};
const V={p:100,n:320,b:330,r:500,q:900,k:20000};
const CO={p:1,n:3,b:3,r:5,q:9,k:0};

function evaluate(ch){
    let s=0,tm=0;const bd=ch.board();
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const p=bd[r][c];if(!p)continue;
        const v=V[p.type];if(p.type!=='k')tm+=v;
        let t=PST[p.type];if(p.type==='k'&&tm<2600)t=PST.k_end;
        const row=p.color==='w'?r:7-r;
        const pv=t?t[row][c]:0;
        s+=(p.color==='w'?1:-1)*(v+pv);
    }
    s+=(ch.turn()==='w'?1:-1)*ch.moves().length*1.5;
    return s;
}

function orderMoves(moves){
    return moves.sort((a,b)=>{
        let sa=0,sb=0;
        if(a.san.includes('#'))sa+=200;if(b.san.includes('#'))sb+=200;
        if(a.captured)sa+=10*(CO[a.captured]||0)-(CO[a.piece]||0);
        if(b.captured)sb+=10*(CO[b.captured]||0)-(CO[b.piece]||0);
        if(a.san.includes('+'))sa+=5;if(b.san.includes('+'))sb+=5;
        return sb-sa;
    });
}

function quiesce(ch,a,b,isMax){
    const sp=evaluate(ch);
    if(isMax){if(sp>=b)return b;if(sp>a)a=sp;}
    else{if(sp<=a)return a;if(sp<b)b=sp;}
    const caps=ch.moves({verbose:true}).filter(m=>m.captured);
    if(!caps.length)return sp;
    orderMoves(caps);
    const lim=caps.slice(0,5);
    for(const m of lim){
        ch.move(m);const sc=quiesce(ch,a,b,!isMax);ch.undo();
        if(isMax){if(sc>a)a=sc;if(a>=b)return b;}
        else{if(sc<b)b=sc;if(a>=b)return a;}
    }
    return isMax?a:b;
}

let nodeCount=0;
const NODE_LIMIT=30000;

function minimax(ch,depth,a,b,isMax,entropy){
    nodeCount++;
    if(nodeCount>NODE_LIMIT)return evaluate(ch);
    if(depth<=0||ch.game_over())return quiesce(ch,a,b,isMax);
    let moves=ch.moves({verbose:true});
    if(!moves.length)return evaluate(ch);
    orderMoves(moves);
    if(depth>=2&&moves.length>12)moves=moves.slice(0,12);

    if(isMax){
        let best=-Infinity;
        for(const m of moves){
            ch.move(m);
            let ev=minimax(ch,depth-1,a,b,false,entropy);
            ch.undo();
            if(depth<=1)ev+=(Math.random()-0.5)*entropy*60;
            if(ev>best)best=ev;if(ev>a)a=ev;if(a>=b)break;
        }
        return best;
    }else{
        let best=Infinity;
        for(const m of moves){
            ch.move(m);
            let ev=minimax(ch,depth-1,a,b,true,entropy);
            ch.undo();
            if(depth<=1)ev+=(Math.random()-0.5)*entropy*60;
            if(ev<best)best=ev;if(ev<b)b=ev;if(a>=b)break;
        }
        return best;
    }
}

const BOOK={
    start:['e4','d4','Nf3','c4'],
    e4:{e5:['Nf3','Bc4','Nc3'],c5:['Nf3','Nc3','c3'],e6:['d4','Nf3'],c6:['d4','Nc3'],Nf6:['e5','Nc3']},
    d4:{d5:['c4','Nf3','Bf4'],Nf6:['c4','Nf3','Bf4'],f5:['c4','Nf3'],e6:['c4','Nf3']},
    Nf3:{Nf6:['c4','d4','g3'],d5:['d4','c4','g3']},
    c4:{e5:['Nc3','g3'],Nf6:['Nc3','Nf3']}
};

function getBookMove(ch){
    const h=ch.history(),leg=ch.moves({verbose:true});let choices=null;
    if(!h.length)choices=BOOK.start;
    else if(h.length===1){const r=BOOK[h[0]];if(r)choices=Object.keys(r);}
    else if(h.length<=5){const r=BOOK[h[0]];if(r&&r[h[1]])choices=r[h[1]];}
    if(choices){
        const shuf=choices.sort(()=>Math.random()-0.5);
        for(const san of shuf){const f=leg.find(m=>m.san===san);if(f)return f;}
    }
    return null;
}

self.onmessage=function(e){
    const{fen,depth,entropy,id}=e.data;
    const ch=new Chess(fen);
    const moves=ch.moves({verbose:true});
    if(!moves.length){self.postMessage({id,result:null});return;}

    // Opening book
    if(ch.history().length<10&&Math.random()>entropy*0.5){
        const bm=getBookMove(ch);
        if(bm){self.postMessage({id,result:{move:bm,eval:0}});return;}
    }

    // Adaptive depth based on move count
    let d=depth;
    if(moves.length>35&&d>2)d=2;
    else if(moves.length>25&&d>3)d=3;

    const isW=ch.turn()==='w';
    orderMoves(moves);
    nodeCount=0;
    let bestMove=moves[0],bestEval=isW?-Infinity:Infinity;

    for(const m of moves){
        ch.move(m);
        const ev=minimax(ch,d-1,-Infinity,Infinity,!isW,entropy);
        ch.undo();
        if(isW?(ev>bestEval):(ev<bestEval)){bestEval=ev;bestMove=m;}
        if(nodeCount>NODE_LIMIT)break;
    }
    self.postMessage({id,result:{move:bestMove,eval:bestEval}});
};
</script>

<script>
// ==================== MAIN THREAD — UI ONLY, ZERO AI WORK ====================
const PM={wP:'♙',wR:'♖',wN:'♘',wB:'♗',wQ:'♕',wK:'♔',bP:'♟',bR:'♜',bN:'♞',bB:'♝',bQ:'♛',bK:'♚'};
const PN={p:'Pawn',r:'Rook',n:'Knight',b:'Bishop',q:'Queen',k:'King'};
const FILES='abcdefgh'.split('');
const $=id=>document.getElementById(id);

// Create worker from inline blob
const worker=new Worker(URL.createObjectURL(new Blob([document.getElementById('worker-src').textContent],{type:'application/javascript'})));
let pendingResolve=null, searchId=0;
worker.onmessage=e=>{if(pendingResolve&&e.data.id===searchId){pendingResolve(e.data.result);pendingResolve=null;}};

function requestAI(fen,depth,entropy){
    return new Promise(resolve=>{searchId++;pendingResolve=resolve;worker.postMessage({fen,depth,entropy,id:searchId});});
}

// Load chess.js for the main thread (board state only)
const chessScript=document.createElement('script');
chessScript.src='https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js';
chessScript.onload=init;
document.head.appendChild(chessScript);

const G={
    chess:null,running:false,paused:false,infinite:false,
    wins:{w:0,b:0},timers:{w:300,b:300},timerInterval:null,
    entropy:0.2,depth:3,speed:1,highlights:[],
    captured:{w:[],b:[]},moveTimeout:null,gameNum:0,lastEval:0
};
const SPEED_CFG=[
    {think:[1200,3000],delay:600},
    {think:[500,1400],delay:300},
    {think:[100,400],delay:80}
];

// Pre-built board squares — never recreated
let sqEls=[];

function buildBoard(){
    const b=$('board');b.innerHTML='';sqEls=[];
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const s=document.createElement('div');
        s.className=`sq ${(r+c)%2===0?'light':'dark'}`;
        s.dataset.r=r;s.dataset.c=c;
        if(r===7){const f=document.createElement('span');f.className='coord coord-file';f.textContent=FILES[c];s.appendChild(f);}
        if(c===0){const rk=document.createElement('span');rk.className='coord coord-rank';rk.textContent=8-r;s.appendChild(rk);}
        b.appendChild(s);sqEls.push(s);
    }
}

function updateBoard(){
    const bd=G.chess.board();
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const idx=r*8+c,s=sqEls[idx],nota=FILES[c]+(8-r);
        const isHL=G.highlights.includes(nota);
        const base=(r+c)%2===0?'light':'dark';
        s.className=`sq ${base}${isHL?' hl':''}`;
        const old=s.querySelector('.pc');if(old)old.remove();
        const p=bd[r][c];
        if(p){
            const e=document.createElement('span');
            e.className=`pc pc-${p.color==='w'?'w':'b'}`;
            e.textContent=PM[p.color+p.type.toUpperCase()];
            if(G.highlights[1]===nota)e.classList.add('moved');
            s.appendChild(e);
        }
    }
}

function fmt(s){return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}
function updateTimers(){
    $('timer-w').textContent=fmt(G.timers.w);$('timer-b').textContent=fmt(G.timers.b);
    $('timer-w').classList.toggle('low-time',G.timers.w<=30);
    $('timer-b').classList.toggle('low-time',G.timers.b<=30);
}

function startTimer(c){
    stopTimer();if(G.paused)return;
    $('card-w').classList.toggle('active-white',c==='w');
    $('card-b').classList.toggle('active-black',c==='b');
    $('analysis-w').classList.toggle('active-w',c==='w');$('analysis-w').classList.remove('active-b');
    $('analysis-b').classList.toggle('active-b',c==='b');$('analysis-b').classList.remove('active-w');
    G.timerInterval=setInterval(()=>{G.timers[c]--;updateTimers();if(G.timers[c]<=0)endGame(c==='w'?'b':'w','timeout');},1000);
}
function stopTimer(){if(G.timerInterval){clearInterval(G.timerInterval);G.timerInterval=null;}}

function updateCaptured(){
    const ord={q:0,r:1,b:2,n:3,p:4};
    ['w','b'].forEach(c=>{
        $(`cap-${c}`).innerHTML=[...G.captured[c]].sort((a,b)=>ord[a]-ord[b]).map(t=>`<span class="cap-piece">${PM[c+t.toUpperCase()]}</span>`).join('');
    });
}

function updateMoveLog(){
    const h=G.chess.history();let html='';
    for(let i=0;i<h.length;i+=2){
        html+=`<span class="move-num">${Math.floor(i/2)+1}.</span> <span class="move-w">${h[i]}</span>`;
        if(h[i+1])html+=` <span class="move-b">${h[i+1]}</span>`;
        html+=' ';
    }
    const el=$('move-log');el.innerHTML=html;el.scrollTop=el.scrollHeight;
}

function updateEvalBar(cp){$('eval-bar').style.width=(50+Math.max(-5,Math.min(5,cp))/5*50)+'%';}

function genAnalysis(color,move,ev){
    const el=$(color==='w'?'analysis-body-w':'analysis-body-b');
    const eel=$(color==='w'?'eval-w':'eval-b');
    const cp=ev/100;
    eel.textContent=(cp>=0?'+':'')+cp.toFixed(1);
    updateEvalBar(cp);
    const lines=[{label:'Move',text:descMove(move)}];
    const pos=posNote();if(pos)lines.push({label:'Position',text:pos});
    lines.push({label:'Plan',text:planNote()});
    el.innerHTML=lines.map(l=>`<div class="analysis-line"><span class="al-label">${l.label}</span>${l.text}</div>`).join('');
}

function descMove(m){
    if(m.san.includes('#'))return 'Checkmate!';
    if(m.san.includes('+')&&m.captured)return `Captures the ${PN[m.captured].toLowerCase()} with check.`;
    if(m.san.includes('+'))return 'Delivers check, forcing a response.';
    if(m.captured){
        const v={p:1,n:3,b:3,r:5,q:9,k:0},vict=PN[m.captured].toLowerCase();
        if(v[m.captured]>v[m.piece])return `Wins the ${vict} — favorable exchange.`;
        if(v[m.captured]===v[m.piece])return `Trades ${PN[m.piece].toLowerCase()} for ${vict}.`;
        return `Captures the ${vict}.`;
    }
    if(m.flags&&(m.flags.includes('k')||m.flags.includes('q')))return 'Castles to secure king safety.';
    return ['Improving piece coordination.','Prophylactic — preventing counterplay.','Preparing a strategic breakthrough.','Maintaining pressure.','Subtle positional improvement.','Consolidating the position.'][Math.floor(Math.random()*6)];
}

function posNote(){
    return [
        'Piece activity is the priority here.','Pawn structure remains balanced.',
        'Control of key central squares is strong.','Rook connectivity will matter soon.',
        'Bishop pair could prove decisive.',null,null
    ][Math.floor(Math.random()*7)];
}

function planNote(){
    return ['Aiming to improve pawn structure.','Looking to open files for the rooks.','Planning a kingside expansion.','Building pressure on the queenside.','Preparing a central break.','Optimizing piece placement.','Seeking tactical complications.','Consolidating before pressing.'][Math.floor(Math.random()*8)];
}

// ==================== GAME LOOP ====================
async function makeMove(){
    if(!G.running||G.paused)return;
    const turn=G.chess.turn();
    const thEl=$(turn==='w'?'think-w':'think-b');
    thEl.innerHTML='<span class="thinking-dots">Calculating</span>';

    const cfg=SPEED_CFG[G.speed];
    const delay=cfg.think[0]+Math.random()*(cfg.think[1]-cfg.think[0]);

    // Run AI in worker + visual delay in parallel
    const[result]=await Promise.all([requestAI(G.chess.fen(),G.depth,G.entropy),new Promise(r=>setTimeout(r,delay))]);
    if(!G.running||G.paused)return;
    if(!result||!result.move)return;

    const move=result.move;
    thEl.textContent=`Played ${move.san}`;
    G.lastEval=result.eval;

    if(move.captured)G.captured[turn==='w'?'b':'w'].push(move.captured);

    // Apply move (try SAN first, fallback to from/to)
    if(!G.chess.move(move.san)){
        if(!G.chess.move({from:move.from,to:move.to,promotion:move.promotion||'q'})){
            console.error('Move failed:',move);return;
        }
    }

    G.highlights=[move.from,move.to];
    updateBoard();updateMoveLog();updateCaptured();
    genAnalysis(turn,move,result.eval);

    $('move-counter').textContent=`Move ${Math.ceil(G.chess.history().length/2)}`;
    $('status-text').innerHTML=`<strong>${turn==='w'?'Nexus':'Hydra'}</strong> plays ${move.san}`;

    if(G.chess.game_over()){
        if(G.chess.in_checkmate())endGame(turn,'checkmate');
        else endGame(null,'draw');
        return;
    }
    startTimer(G.chess.turn());
    G.moveTimeout=setTimeout(makeMove,cfg.delay);
}

function startGame(){
    if(G.moveTimeout)clearTimeout(G.moveTimeout);
    stopTimer();searchId++;pendingResolve=null;

    G.chess=new Chess();G.running=true;G.paused=false;
    G.timers={w:300,b:300};G.highlights=[];G.captured={w:[],b:[]};G.lastEval=0;G.gameNum++;

    updateBoard();updateTimers();updateCaptured();
    $('move-log').innerHTML='';
    $('analysis-body-w').innerHTML='<div style="color:var(--text-muted);font-style:italic">Thinking…</div>';
    $('analysis-body-b').innerHTML='<div style="color:var(--text-muted);font-style:italic">Waiting…</div>';
    $('eval-w').textContent='0.0';$('eval-b').textContent='0.0';$('eval-bar').style.width='50%';
    $('status-dot').className='status-dot live';
    $('status-text').innerHTML=`Game #${G.gameNum} — <strong>Nexus</strong> to move.`;
    $('move-counter').textContent='';
    $('btn-start').innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 2v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 8"/></svg> Reset`;
    $('btn-pause').disabled=false;
    startTimer('w');makeMove();
}

function endGame(winner,reason){
    G.running=false;stopTimer();
    if(G.moveTimeout)clearTimeout(G.moveTimeout);
    searchId++;pendingResolve=null;
    $('status-dot').className='status-dot ended';
    if(winner){G.wins[winner]++;$('score-w').textContent=G.wins.w;$('score-b').textContent=G.wins.b;}
    let msg='';
    if(reason==='checkmate')msg=`Checkmate! <strong>${winner==='w'?'Nexus':'Hydra'}</strong> wins.`;
    else if(reason==='timeout')msg=`Time out — <strong>${winner==='w'?'Nexus':'Hydra'}</strong> wins.`;
    else msg='Game drawn.';
    $('status-text').innerHTML=msg;$('btn-pause').disabled=true;
    $('think-w').textContent='';$('think-b').textContent='';
    $('card-w').className='engine-card white-engine';$('card-b').className='engine-card black-engine';
    $('analysis-w').className='analysis-box';$('analysis-b').className='analysis-box';
    if(G.infinite)setTimeout(startGame,2500);
}

function togglePause(){
    if(!G.running)return;G.paused=!G.paused;
    const btn=$('btn-pause');
    if(G.paused){
        stopTimer();if(G.moveTimeout)clearTimeout(G.moveTimeout);searchId++;pendingResolve=null;
        btn.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg> Resume`;
        $('status-text').innerHTML='<strong>Paused</strong>';
    }else{
        btn.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Pause`;
        startTimer(G.chess.turn());makeMove();
    }
}

function toggleInfinite(){
    G.infinite=!G.infinite;const btn=$('btn-infinite');
    btn.classList.toggle('active-toggle',G.infinite);
    btn.innerHTML=G.infinite
        ?`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18.2 8c5 0 5 8 0 8H12m-6.2 0c-5 0-5-8 0-8H12"/></svg> Loop: ON`
        :`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18.2 8c5 0 5 8 0 8H12m-6.2 0c-5 0-5-8 0-8H12"/></svg> Loop`;
}

$('entropy-slider').addEventListener('input',e=>{G.entropy=e.target.value/100;$('entropy-val').textContent=G.entropy.toFixed(2);});
$('depth-slider').addEventListener('input',e=>{G.depth=parseInt(e.target.value);$('depth-val').textContent=G.depth;});
$('speed-slider').addEventListener('input',e=>{G.speed=parseInt(e.target.value);$('speed-val').textContent=['Slow','Normal','Fast'][G.speed];});
$('btn-start').addEventListener('click',startGame);
$('btn-pause').addEventListener('click',togglePause);
$('btn-infinite').addEventListener('click',toggleInfinite);

function init(){G.chess=new Chess();buildBoard();}
</script>
</body>
</html>